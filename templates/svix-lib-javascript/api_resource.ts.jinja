// this file is @generated
{% set resource_type_name = resource.name | to_upper_camel_case -%}

import {
    {% for c in referenced_components -%}
        {{ c | to_upper_camel_case }},
    {% endfor -%}
} from "../openapi";
import { HttpMethod, SvixRequest, SvixRequestContext } from "../request";
{% if resource.has_post_operation -%}
import { PostOptions } from "../util";
{%- endif %}

{% for op in resource.operations -%}
    {% if op.query_params | length > 0 -%}
    export interface {{ resource_type_name }}{{ op.name | to_upper_camel_case }}Options {
        {% for p in op.query_params -%}
            {{ p.description | to_doc_comment(style="js") }}
            {% set field_ty = p.type.to_js() -%}
            {% if p.name == "iterator" %}{% set field_ty = "string | null" %}{% endif -%}
            {{ p.name | to_lower_camel_case }}{% if not p.required %}?{% endif %}: {{ field_ty }};
        {% endfor -%}
    }

    {% endif -%}
{% endfor -%}

export class {{ resource_type_name }} {
    public constructor(private readonly requestCtx: SvixRequestContext) {}

    {% for op in resource.operations -%}
        {% set has_query_params = op.query_params | length > 0 -%}
        {% set has_required_query_params =
            op.query_params | selectattr("required") | length > 0 -%}
        {% set has_header_params = op.header_params | length > 0 -%}
        {% set response_type =
            op.response_body_schema_name | default("void") | replace("_", "") -%}
        {{ op.description | with_javadoc_deprecation(op.deprecated) | to_doc_comment(style="js") }}
        public {{ op.name | to_lower_camel_case }}(
            {# path parameters -#}
            {% for p in op.path_params -%}
                {{ p | to_lower_camel_case }}: string,
            {% endfor -%}

            {# body parameter interface -#}
            {% if op.request_body_schema_name is defined -%}
                {% set field_name = op.request_body_schema_name | to_lower_camel_case -%}
                {{ field_name }}: {{ op.request_body_schema_name }},
            {% endif -%}

            {# query parameters -#}
            {% if has_query_params  -%}
                {% set field_ty -%}
                    {{ resource_type_name }}{{ op.name | to_upper_camel_case }}Options
                {%- endset -%}
                options{% if not has_required_query_params %}?{% endif %}: {{ field_ty }},
            {% endif -%}

            {# PostOptions -#}
            {% if has_header_params -%}
                {# for now, only idempotency-key is supported in header params -#}
                options?: PostOptions,
            {% endif -%}
        ): Promise<{{ response_type }}> {
            const request = new SvixRequest(HttpMethod.{{ op.method | upper }}, "{{ op.path }}");

            {# path parameters -#}
            {% for p in op.path_params -%}
                request.setPathParam("{{ p }}", {{ p | to_lower_camel_case }});
            {% endfor -%}

            {# query parameters -#}
            {% for p in op.query_params -%}
                request.setQueryParam("{{ p.name }}", options?.{{ p.name | to_lower_camel_case }});
            {% endfor -%}

            {# header parameters -#}
            {% for p in op.header_params -%}
                request.setHeaderParam("{{ p.name }}", options?.{{ p.name | to_lower_camel_case }});
            {% endfor -%}

            {# body parameter -#}
            {% if op.request_body_schema_name is defined -%}
                request.body = {{ op.request_body_schema_name | to_lower_camel_case }};
            {% endif -%}

            {% if op.response_body_schema_name is defined %}
                return request.send(this.requestCtx);
            {% else %}
                return request.sendNoResponseBody(this.requestCtx);
            {% endif -%}
        }

        {% set extra_path -%}
            api_extra/{{ resource.name | to_snake_case }}_{{ op.name | to_snake_case }}.ts
        {%- endset -%}
        {% include extra_path ignore missing %}

    {% endfor -%}
}

{% set extra_path -%}
    api_extra/{{ resource.name | to_snake_case }}.ts
{%- endset -%}
{% include extra_path ignore missing %}
